---

- tags: [build, boost]
  block:

    - name: install build dependencies
      apt: name=build-essential
      become: yes

    - name: create build directories
      file: path={{ item }} state=directory
      with_items:
        - "{{ boost_root }}"
        - "{{ boost_build_dir }}"

    - name: download source tarball
      get_url: url={{ boost_tarball_url }} dest={{ boost_tarball }}
               checksum={{ boost_tarball_checksum }}

    # NOTE: Too bad `unarchive` module cannot handle Boost's tarball :(
    - name: unarchive source tarball
      command: tar xjf {{ boost_tarball }}
               chdir={{ boost_root }}
               creates={{ boost_src }}

    - name: configure
      command: ./bootstrap.sh --prefix={{ boost_prefix }} {{ boost_configs }}
               chdir={{ boost_src }}
               creates={{ boost_src }}/project-config.jam

    - name: build
      command: ./b2 --build-dir={{ boost_build_dir }}
                    --stagedir={{ boost_build_dir }}/stage
                    variant=release
                    link=shared
                    threading=multi
                    runtime-link=shared
                    stage
               chdir={{ boost_src }}
               creates={{ boost_build_dir }}/boost

    - name: install
      command: ./b2 --build-dir={{ boost_build_dir }}
                    variant=release
                    link=shared
                    threading=multi
                    runtime-link=shared
                    install
               chdir={{ boost_src }}
               creates={{ boost_prefix }}/include/boost
      become: yes

- tags: [archive, boost]
  block:

    - name: archive core runtime libraries
      include: tasks/copy-core-libs.yml

    - name: archive c++ runtime libraries
      include: tasks/copy.yml
               path=/usr/lib/x86_64-linux-gnu patterns=libstdc++.so*
               dest={{ build_out }}

    - name: archive boost runtime libraries
      include: tasks/copy.yml
               path={{ boost_prefix }}/lib patterns=libboost*
               dest={{ build_out }}
